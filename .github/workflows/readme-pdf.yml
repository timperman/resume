name: Generate README PDF

on:
  push:
    branches: [main]
    paths:
      - .github/workflows/readme-pdf.yml
      - README.md

permissions:
  contents: write

jobs:
  generate-pdf:
    name: Generate RESUME.pdf
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate PDF (XeLaTeX + GitHub-ish fonts + emoji)
        run: |
          docker run --rm \
            --entrypoint /bin/sh \
            -v "${PWD}:/data" \
            -w /data \
            pandoc/latex:latest \
            -c '
              set -e

              echo "== OS info =="
              (cat /etc/os-release || true)
              echo "== Installing fonts =="

              if command -v apt-get >/dev/null 2>&1; then
                apt-get update
                apt-get install -y --no-install-recommends \
                  fontconfig \
                  fonts-noto \
                  fonts-noto-mono \
                  fonts-noto-color-emoji
                rm -rf /var/lib/apt/lists/*
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache \
                  fontconfig \
                  ttf-dejavu \
                  font-noto \
                  font-noto-cjk \
                  font-noto-emoji \
                  texlive \
                  texmf-dist \
                  texmf-dist-latex \
                  texmf-dist-latexextra \
                  texmf-dist-fontsrecommended \
                  texmf-dist-fontsextra
              else
                echo "No supported package manager found (apt-get/apk)."
                exit 1
              fi

              fc-cache -f || true

              # sanity check (fail fast)
              kpsewhich fontawesome5.sty >/dev/null 2>&1 || (echo "fontawesome5.sty not found even after installs" && exit 1)

              echo "== Building PDF with XeLaTeX =="
              pandoc README.md \
                --pdf-engine=lualatex \
                -H header.tex \
                --lua-filter=filters/gh-pdf-conditional.lua \
                -V mainfont="Noto Sans" \
                -V monofont="Noto Sans Mono" \
                -V fontsize=11pt \
                -V geometry:margin=1in \
                -o RESUME.pdf

              ls -la RESUME.pdf
            '
      - name: Verify output exists
        run: |
          ls -la
          test -f RESUME.pdf

      - name: Commit PDF
        run: |
          if ! git status --porcelain -- RESUME.pdf | grep -q .; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add RESUME.pdf
          git commit -m "chore: update RESUME PDF from README.md"
          git push
